---
title: "MissionControl v2"
author: "Managed by Data Science and `r sprintf('rendered at %s PST',Sys.time())`"
output:
  html_document:
    toc: false
    toc_depth: 5
params:
    isPublic: no
    
---


<head>
<link href="https://fonts.googleapis.com/css?family=Nunito|Quattrocento+Sans|Roboto+Mono:300&display=swap" rel="stylesheet"> 
</head>


```{js echo=FALSE}
function addHeaderLinks() {
        $("h1,h2,h3,h4,h5").filter(function(i) {
            // Note: tried selecting "div.section > h1,h2,h3,h4,h5", but 
            // this was pulling in the initial h4 date heading.
            return $(this).parent().hasClass("section");
        }).wrap(function() {
            var sectionref = $(this).parent().attr("id");
            // Add a custom class for additional styling control.
            return "<a class='header-link' href='#" + sectionref + "'></a>";
        });
}
$(document).ready(function() {
                addHeaderLinks();
});
```

<style>
body {
    line-height: 1.4em;
    font-family: 'Quattrocento Sans', sans-serif;
    background-color: transparent;
    }
    

.break-out {
    text-align: center;
    width: 100vw;
    position: relative;
    left: calc(-1 * (100vw - 100%)/2);
}
.r {
    background-color: white;
    border: 0;
        }

pre code, pre, code {
  white-space: pre !important;
  overflow-x: scroll !important;
  word-break: keep-all !important;
  word-wrap: initial !important;
}

h1,h2,h3,h4,h5,h6 {
    font-family: 'Nunito', sans-serif;
}

table {
font-family: 'Roboto Mono', monospace;
font-size: 85%;
}

pre,code {
    border:0;
    font-family: 'Roboto Mono', monospace;
    font-size: 80%;
}

ul.navtabs !{
    border:0;
}

</style>




```{r Z0,echo=FALSE}
knitr::opts_chunk$set(  echo=FALSE,warning=FALSE,message=FALSE,eval=TRUE)
```

```{r Z1,echo=FALSE,warning=FALSE, results='hide',message=FALSE,eval=if(exists("_donotrun_")) FALSE else TRUE}

library(DT)
source("../missioncontrol.lib.R")
g <- bq()
channel.info <- function(channel,g){
    list(
        version = posterior.current.versions(channel,g=g),
        usage   = posterior.usage(channel,g=g),
        summary = posterior.rate.incidence.summary(channel,g=g),
        evolution = posterior.evolution(channel,g=g),
        change = if(channel %in% c('release','esr')) posterior.version.change(channel,3) else NULL
    )
}
release.info <- channel.info('release',g)
beta.info <- channel.info('beta',g)
nightly.info <- channel.info('nightly',g)
esr.info <- channel.info('esr',g)

```

```{r Z3,echo=FALSE,warning=FALSE, results='hide',message=FALSE,eval=if(exists("_donotrun_")) FALSE else TRUE}
ccsv <- rbindlist(list(posterior.evolution('release',6,g),
                       posterior.evolution('beta',6,g),
                       posterior.evolution('nightly',6,g),
                       posterior.evolution('esr',6,g)
                       ))


plotEvolution <- function(f, title, xtip,width=NULL,height=NULL,showlegend=TRUE,pointSize=65,x.is.date=FALSE){
    u3 <- list(
        `$schema` = vega_schema(),
        data = list(values = f),
        title = list(text=glue(title), anchor='start',fontWeight = 'normal'),
        width = if(is.null(width)) 1200 else width,
        height = if(is.null(height)) 300 else height,
        autosize = list(type='fit',contains='content'),
        layer = list(
            list(
                mark = list(type="point",filled=TRUE),
                selection = list(
                    grid = list(type= "interval", bind="scales"),
                    opsys = list(type='multi',fields=list("os"),bind='legend')
                ),
                transform = list(list(calculate="format(datum.c,'.2f')+' ('+format(datum.lo90,'.2f')+','+format(datum.hi90,'.2f')+')'", as=xtip),
                                 list(calculate='format(datum.adoption*100,".2f")+"%"',as='Adoption')
                                 ,list(calculate="datum.cv+' (v'+ format(datum.major,'d')+')'",as='cv2')
                                 )
                                ,
                encoding = list(
                    size = list(value=pointSize),
                    x = if(x.is.date){
                            list(field="date", timeUnit= "utcyearmonthdate",type='temporal', axis=list(title="Model Date",labelOverlap='parity')) 
                        }else{
                            list(field="cv", type='ordinal', axis=list(title="",labelOverlap='parity'), sort=list(field="ordering",op='count'))
                        },
                    y = list(field="c",type="quantitative",axis=list(title="",titleFontSize=11)),
                    color = list(field = "os", type = "nominal",scale=list(scheme="set1")),
                    shape=if(x.is.date) NULL else list(field='major', type='nominal'),
                    opacity = list(condition = list(selection="opsys",value = 1),value = 0.1),
                    tooltip=list(list(field = "Date",type="ordinal"),
                                 list(field=if('nightly' %in% f$channel) 'cv2' else 'cv', type='ordinal',title='Version'),
                                 list(field='cv', type='ordinal',title='Version'),
                                 list(field = "Adoption",type="ordinal"),
                                 list(field = xtip,type="ordinal")
                                 )
                )),
            list(
                mark = list(type="rule","strokeDash"=list(4, 2)),
                encoding = list(
                    size = list(value=1),
                    x =  if(x.is.date){
                             list(field="date", timeUnit= "utcyearmonthdate",  type='ordinal', axis=list(title="Model Date",labelOverlap='parity'))
                         }else{
                             list(field="cv", type='ordinal',sort=list(field="ordering",op='count'))
                         },
                    y = list(field="lo90",type="quantitative",  grid=FALSE),
                    y2 = list(field="hi90",type="quantitative",  grid=FALSE),
                    opacity = list(condition = list(selection="opsys",value = 0.4),value = 0.1),
                    color = list(field = "os", type = "nominal",scale=list(scheme="grey")),
                    tooltip =  NULL
                ))
        )
    )
    u3
}


makePlot <- function(evo,typec,title,xtip,width=990,height=200){
    xx <- evo[os!='overall' & modelname == typec,]
    xx <-merge(xx, xx[, .SD[order(major,minor),][,list(date, major,minor, ordering = 1:.N)],by=os], by=c("os","date","major","minor"))
    xx[, Date := strftime(date,"%Y-%m-%d")]
    if(xtip=='Incidence') xx[,':='(c = c*100,lo90=lo90*100,hi90=hi90*100)]
    xy <- plotEvolution(xx, title=title, xtip=xtip,width=width,height=height)
    vegawidget(as_vegaspec(xy),embed=vega_embed(actions=TRUE))
}


```

##  {.tabset}



*Take results from products with less than 10% adoption with adequate  skepticism*


### Release 

`asOf` is the date till which the model uses data


```{r Z4,eval=TRUE, echo=FALSE}

datatable(release.info$version, caption = 'Comparing Current Version To ... ',
          colnames=c("Current Version","Days Present","Older Version","Days Present", "asOf"),
          options = list(
              searching = FALSE,columnDefs = list(list(className = 'dt-center',targets="_all")),
              pageLength = 1,lengthChange = FALSE,dom = 't'),rownames= FALSE
          )

datatable(release.info$usage[, DAU_on_Current := if(params$isPublic=='yes') NA else  DAU_on_Current],   caption = 'Usage on Current',
          colnames=c("OS","Adoption","Total Crashes","DAU On Current"),
          options = list(
              searching = FALSE,columnDefs = list(list(className = 'dt-center',targets="_all")),
              pageLength = nrow(release.info$usage),lengthChange = FALSE,dom = 't'),rownames= FALSE
          ) 



```



```{r echo=FALSE}
datatable(release.info$summary[type=='rate',list(os,Score,CM,CC)], caption = 'Crash Rate Summary',
          rownames=FALSE,colnames=c('OS','Score','Main Crash','Content Crash'),
          options = list(
              searching = FALSE,dom='t',lengthChange=FALSE,
              columnDefs = list(list(className = 'dt-center',targets="_all")),
              pageLength = nrow(release.info$summary)))

datatable(release.info$summary[type=='incidence',list(os,Score,CM,CC)], caption = 'Crash Incidence Summary',
          rownames=FALSE,colnames=c('OS','Score','Main Crash','Content Crash'),
          options = list(
              searching = FALSE,dom='t',lengthChange=FALSE,
              columnDefs = list(list(className = 'dt-center',targets="_all")),
              pageLength = nrow(release.info$summary)))

```




- Click on an OS in the legend to hide others and click on the chart to bring
them all back
- use scroll to zoom in/out figures


```{r echo=FALSE}
makePlot(release.info$evolution, 'cmr',"Main Crash Rate","Rate")
makePlot(release.info$evolution, 'ccr',"Content Crash Rate","Rate")
makePlot(release.info$evolution, 'cmi',"Main Crash Incidence(%)","Incidence")
makePlot(release.info$evolution, 'cci',"Content Crash Incidence(%)","Incidence")

```


#### Estimates of Release Crash Rate over Time for Current Version

```{r echo=FALSE}
w <- plotEvolution(release.info$change[modelname=='cr',][, date := strftime(as.Date(model_date) , "%Y-%m-%d")][, Date := date], title="Crash Rate SCORE", xtip='Rate',width=990,height=300,x.is.date=TRUE)
vegawidget(as_vegaspec(w),embed=vega_embed(actions=TRUE))

w <- plotEvolution(release.info$change[modelname=='ci',][, ':='(date = as.Date(model_date),c = c*100,lo90=lo90*100,hi90=hi90*100)][, date := strftime(date , "%Y-%m-%d")][, Date := date]
                 , title="Crash Incidence SCORE(%)", xtip='Incidence',width=990,height=300,x.is.date=TRUE)
vegawidget(as_vegaspec(w),embed=vega_embed(actions=TRUE))

```

### Beta



`asOf` is the date till which the model uses data



```{r}

datatable(beta.info$version, caption = 'Comparing Current Version To ... ',
          colnames=c("Current Version","Days Present","Older Version","Days Present", "asOf"),
          options = list(
              searching = FALSE,columnDefs = list(list(className = 'dt-center',targets="_all")),
              pageLength = nrow(beta.info$version),lengthChange = FALSE,dom = 't'),rownames= FALSE
          )

datatable(beta.info$usage[, DAU_on_Current := if(params$isPublic=='yes') NA else  DAU_on_Current],  caption = 'Usage on Current',
          colnames=c("OS","Adoption","Total Crashes","DAU On Current"),
          options = list(
              searching = FALSE,columnDefs = list(list(className = 'dt-center',targets="_all")),
              pageLength = nrow(beta.info$usage),lengthChange = FALSE,dom = 't'),rownames= FALSE
          ) 



```




```{r}
datatable(beta.info$summary[type=='rate',list(os,Score,CM,CC)], caption = 'Crash Rate Summary',
          rownames=FALSE,colnames=c('OS','Score','Main Crash','Content Crash'),
          options = list(
              searching = FALSE,dom='t',lengthChange=FALSE,
              columnDefs = list(list(className = 'dt-center',targets="_all")),
              pageLength = nrow(beta.info$summary)))

datatable(beta.info$summary[type=='incidence',list(os,Score,CM,CC)], caption = 'Crash Incidence Summary',
          rownames=FALSE,colnames=c('OS','Score','Main Crash','Content Crash'),
          options = list(
              searching = FALSE,dom='t',lengthChange=FALSE,
              columnDefs = list(list(className = 'dt-center',targets="_all")),
              pageLength = nrow(beta.info$summary)))

```



- Click on an OS in the legend to hide others and click on the chart to bring
them all back
- use scroll to zoom in/out figures





```{r}
makePlot(beta.info$evolution, 'cmr',"Main Crash Rate","Rate")
makePlot(beta.info$evolution, 'ccr',"Content Crash Rate","Rate")
makePlot(beta.info$evolution, 'cmi',"Main Crash Incidence(%)","Incidence")
makePlot(beta.info$evolution, 'cci',"Content Crash Incidence(%)","Incidence")

```









### Nightly

`asOf` is the date till which the model uses data

```{r}

datatable(nightly.info$version, caption = 'Comparing Current Version To ... ',
          colnames=c("Current Version","Days Present","Older Version","Days Present", "asOf"),
          options = list(
              searching = FALSE,columnDefs = list(list(className = 'dt-center',targets="_all")),
              pageLength = nrow(nightly.info$version),lengthChange = FALSE,dom = 't'),rownames= FALSE
          )

datatable(nightly.info$usage[, DAU_on_Current := if(params$isPublic=='yes') NA else  DAU_on_Current],  caption = 'Usage on Current',
          colnames=c("OS","Adoption","Total Crashes","DAU On Current"),
          options = list(
              searching = FALSE,columnDefs = list(list(className = 'dt-center',targets="_all")),
              pageLength = nrow(nightly.info$usage),lengthChange = FALSE,dom = 't'),rownames= FALSE
          ) 



```


```{r}
datatable(nightly.info$summary[type=='rate',list(os,Score,CM,CC)], caption = 'Crash Rate Summary',
          rownames=FALSE,colnames=c('OS','Score','Main Crash','Content Crash'),
          options = list(
              searching = FALSE,dom='t',lengthChange=FALSE,
              columnDefs = list(list(className = 'dt-center',targets="_all")),
              pageLength = nrow(nightly.info$summary)))

datatable(nightly.info$summary[type=='incidence',list(os,Score,CM,CC)], caption = 'Crash Incidence Summary',
          rownames=FALSE,colnames=c('OS','Score','Main Crash','Content Crash'),
          options = list(
              searching = FALSE,dom='t',lengthChange=FALSE,
              columnDefs = list(list(className = 'dt-center',targets="_all")),
              pageLength = nrow(nightly.info$summary)))

```


- Click on an OS in the legend to hide others and click on the chart to bring
them all back
- use scroll to zoom in/out figures





```{r}
makePlot(nightly.info$evolution, 'cmr',"Main Crash Rate","Rate")
makePlot(nightly.info$evolution, 'ccr',"Content Crash Rate","Rate")
makePlot(nightly.info$evolution, 'cmi',"Main Crash Incidence(%)","Incidence")
makePlot(nightly.info$evolution, 'cci',"Content Crash Incidence(%)","Incidence")

```



### ESR 

`asOf` is the date till which the model uses data


```{r eval=TRUE, echo=FALSE}

datatable(esr.info$version, caption = 'Comparing Current Version To ... ',
          colnames=c("Current Version","Days Present","Older Version","Days Present", "asOf"),
          options = list(
              searching = FALSE,columnDefs = list(list(className = 'dt-center',targets="_all")),
              pageLength = 1,lengthChange = FALSE,dom = 't'),rownames= FALSE
          )

datatable(esr.info$usage[, DAU_on_Current := if(params$isPublic=='yes') NA else  DAU_on_Current],   caption = 'Usage on Current',
          colnames=c("OS","Adoption","Total Crashes","DAU On Current"),
          options = list(
              searching = FALSE,columnDefs = list(list(className = 'dt-center',targets="_all")),
              pageLength = nrow(release.info$usage),lengthChange = FALSE,dom = 't'),rownames= FALSE
          ) 



```



```{r echo=FALSE,eval=nrow(esr.info)>0}
datatable(esr.info$summary[type=='rate',list(os,Score,CM,CC)], caption = 'Crash Rate Summary',
              rownames=FALSE,colnames=c('OS','Score','Main Crash','Content Crash'),
              options = list(
                  searching = FALSE,dom='t',lengthChange=FALSE,
                  columnDefs = list(list(className = 'dt-center',targets="_all")),
                  pageLength = nrow(esr.info$summary)))
datatable(esr.info$summary[type=='incidence',list(os,Score,CM,CC)], caption = 'Crash Incidence Summary',
              rownames=FALSE,colnames=c('OS','Score','Main Crash','Content Crash'),
              options = list(
                  searching = FALSE,dom='t',lengthChange=FALSE,
                  columnDefs = list(list(className = 'dt-center',targets="_all")),
                  pageLength = nrow(esr.info$summary)))

```




- Click on an OS in the legend to hide others and click on the chart to bring
them all back
- use scroll to zoom in/out figures


```{r echo=FALSE,eval=TRUE}
makePlot(esr.info$evolution, 'cmr',"Main Crash Rate","Rate")
makePlot(esr.info$evolution, 'ccr',"Content Crash Rate","Rate")
makePlot(esr.info$evolution, 'cmi',"Main Crash Incidence(%)","Incidence")
makePlot(esr.info$evolution, 'cci',"Content Crash Incidence(%)","Incidence")

```


#### Estimates of Release Crash Rate over Time for Current Version

```{r echo=FALSE,eval=TRUE}
w <- plotEvolution(esr.info$change[modelname=='cr',][, date := strftime(as.Date(model_date) , "%Y-%m-%d")][, Date := date], title="Crash Rate SCORE", xtip='Rate',width=990,height=300,x.is.date=TRUE)
vegawidget(as_vegaspec(w),embed=vega_embed(actions=TRUE))

w <- plotEvolution(esr.info$change[modelname=='ci',][, ':='(date = as.Date(model_date),c = c*100,lo90=lo90*100,hi90=hi90*100)][, date := strftime(date , "%Y-%m-%d")][, Date := date]
                 , title="Crash Incidence SCORE(%)", xtip='Incidence',width=990,height=300,x.is.date=TRUE)
vegawidget(as_vegaspec(w),embed=vega_embed(actions=TRUE))


```



### Definitions, Downloads, and Model Summary

- **Crash Incidence** is the proportion of DAU experiencing a crash (content or
  main as the case may be)
- **Crash Rate** is the crashes/active hour for the profiles experiencing  a crash  
- **os** is the operating system(Windows,Darwin,Linux and *overall* which is the average of the first three)
- **date** is the date on which this estimate was computed
- **cv** the version
- **major** and **minor** the major and minor components
- **adoption** what percent of DAU was from this version on the given `date`
- **modelname** we have four (+2) different metrics
  - **cmi** is *Main Crash Incidence*, the proportion of DAU on that version that experience a main crash
  - **cmr** is *Main Crash Rate*, the number of crashes per active hour for the people experiencing crash
  - **cci** and **ccr** are similar to the above but for *Content* crashes
  - **cm** and **cc** are the *sum* of **(cmi,ccr)** and **(cmicci)** respectively
- **c** is the actual rate/incidence (incidence is a proportion)
- **lo90** and **hi90** are upper and lower bounds

All estimates are comparable in that they estimated at comparable adoptions and
other parameters


In the 'Summary Tables' , the format `X (Y%)` is the actual rate followed by the percent relative change wrt to the `Older_Version`. Based on the following rules

- if we are more than 75% confident of 20%+ regression you will see a ▲ 
- if we are between 60-75% confident of a 20%+ regression you will see △
- if we are more than 75% confident of a 20%+ improvement you will see a ▼ arrow
- otherwise nothing

#### Downloads and Code

The code for this webpage can be found
[here](https://github.com/mozilla/missioncontrol-v2/blob/store_posterior_approach/mc2/missioncontrol_v2.Rmd)
and in particular depends on several SQL queries found
[here](https://github.com/mozilla/missioncontrol-v2/blob/store_posterior_approach/missioncontrol.lib.R#L380).

But you if you were dissatisfied with this dashboard you would not be able to
create a better one without the data. I've placed several CSV files for you to
produce alternative dashboards.

```{r echo=FALSE}
comparing.to <- cbind(data.table(channel = c("release","beta","nightly","esr")),
                      rbindlist(lapply(list(release.info,beta.info,nightly.info, esr.info),
                                       function(s) s$version)))
usage.on <- rbindlist(
    Map(function(ch,s){
        s$usage[, channel := ch][,]
    },c("release","beta","nightly","esr"),
    list(release.info,beta.info,nightly.info, esr.info)))
usage.on <- usage.on[, list(channel,OS,Adoption, Total_Crashes)]


summary.on <- rbindlist(
    Map(function(ch,s){
        s$summary[, channel := ch][,]
    },c("release","beta","nightly","esr"),
    list(release.info,beta.info,nightly.info, esr.info)))

downloads.days <- 3
if(exists("_donotrun_")){
    al <- g$q(glue("select channel,os, c_version,major,minor,  model_date, date, nvc, modelname, rep, posterior from
`moz-fx-data-derived-datasets`.analysis.missioncontrol_v2_posteriors
where  model_date>='{Sys.Date()-downloads.days}'"),-1)
}

fwrite(ccsv,file="./mc2_rate_incidence_evolution.csv",row.names=FALSE,quote=TRUE,na=0)
fwrite(comparing.to,file="./comparing_version.csv",row.names=FALSE,quote=TRUE,na=0)
fwrite(usage.on,file="./usage_on.csv",row.names=FALSE,quote=TRUE,na=0)
fwrite(summary.on,file="./summary_on.csv",row.names=FALSE,quote=TRUE,na=0)
fwrite(al,"./post_raw.csv")
system("gzip -c ./post_raw.csv > ./post_raw.csv.gz")
```

1. The "comparing current version to..." table can be found [here](./comparing_version.csv).
2. The "usage on current" table can be found [here](./usage_on.csv) (You'll
  need to remove some commas from numbers)
3. The "Crash Rate Summary" and "Crash Incidence Summary" can be found [here](./summary_on.csv).
4. The estimates of estimated crash rates/incidences for all channels along with
error bands can be found [here](./mc2_rate_incidence_evolution.csv)
(last 6 months)
5.  But really what you need is the _raw_ data I used to compute (3) and most of
(4). This [zipped](./post_raw.csv.gz)  file contains 1000 draws from the posteriors for every model(one for each
channel and model (rate or incidence)). How were these used to derive the
tables? Its an involved process but see
[RMD](https://github.com/mozilla/missioncontrol-v2/blob/store_posterior_approach/mc2/missioncontrol_v2.Rmd)
file and the  SQL queries it references. Note the zip file contains data for models
computed in last `r downloads.days`  days. You'd need to scrape this page and
combine data across zip files to build a complete history. Be sure to "dedupe" on `channel,os,c_version, model_date, date`.




#### Model Summary

```{r echo=FALSE,comment=""}
y <- model.summary(g)
cat(y$allmods)
```
