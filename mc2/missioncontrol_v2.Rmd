---
title: "MissionControl v2"
author: "Managed by Data Science, and  `r sprintf('rendered on %s',Sys.time())`"
output:
  html_document:
    toc: false
    toc_depth: 5
params:
    isPublic: no
    
---

```{js echo=FALSE}
$("h1,h2,h3,h4,h5").filter(function(i) {
    // Note: tried selecting "div.section > h1,h2,h3,h4,h5", but 
    // this was pulling in the initial h4 date heading.
    return $(this).parent().hasClass("section");
}).wrap(function() {
    var sectionref = $(this).parent().attr("id");
    // Add a custom class for additional styling control.
    return "<a class='header-link' href='#" + sectionref + "'></a>";
});
```


<style>
body {
    line-height: 1.4em;
    }
.break-out {
    text-align: center;
    width: 100vw;
    position: relative;
    left: calc(-1 * (100vw - 100%)/2);
}
.r {
    background-color: white;
    border: 0;
        }

pre code, pre, code {
  white-space: pre !important;
  overflow-x: scroll !important;
  word-break: keep-all !important;
  word-wrap: initial !important;
}

</style>




```{r echo=FALSE}
knitr::opts_chunk$set(  echo=FALSE,warning=FALSE,message=FALSE,eval=TRUE)
```

```{r echo=FALSE,warning=FALSE, results='hide',message=FALSE,eval=if(exists("_donotrun_")) FALSE else TRUE}
library(DT)
source("../missioncontrol.lib.R")
g <- bq()
channel.info <- function(channel,g){
    list(
        version = posterior.current.versions(channel,g=g),
        usage   = posterior.usage(channel,g=g),
        summary = posterior.rate.incidence.summary(channel,g=g),
        evolution = posterior.evolution(channel,g=g)
    )
}
release.info <- channel.info('release',g)
beta.info <- channel.info('beta',g)
nightly.info <- channel.info('nightly',g)
ccsv <- rbindlist(list(posterior.evolution('release',6,g),
                       posterior.evolution('beta',6,g),
                       posterior.evolution('nightly',6,g)))
fwrite(ccsv,file="./mc2_rate_incidence_evolution.csv",row.names=FALSE,quote=TRUE,na=0)

plotEvolution <- function(f, title, xtip,width=NULL,height=NULL,showlegend=TRUE,pointSize=65){
    u3 <- list(
        `$schema` = vega_schema(),
        data = list(values = f),
        title = list(text=glue(title), anchor='start',fontWeight = 'normal'),
        width = if(is.null(width)) 1200 else width,
        height = if(is.null(height)) 300 else height,
        autosize = list(type='fit',contains='content'),
        layer = list(
            list(
                mark = list(type="point",filled=TRUE),
                selection = list(
                    grid = list(type= "interval", bind="scales"),
                    opsys = list(type='multi',fields=list("os"),bind='legend')
                ),
                transform = list(list(calculate="format(datum.c,'.2f')+' ('+format(datum.lo90,'.2f')+','+format(datum.hi90,'.2f')+')'", as=xtip),
                                 list(calculate='format(datum.adoption*100,".2f")+"%"',as='Adoption')
                                 ,list(calculate="datum.cv+' (v'+ format(datum.major,'d')+')'",as='cv2')
                                 )
                                ,
                encoding = list(
                    size = list(value=pointSize),
                    x = list(field="cv", type='ordinal', axis=list(title="",labelOverlap='parity'), sort=list(field="ordering",op='count')),
                    y = list(field="c",type="quantitative",axis=list(title="",titleFontSize=11)),
                    color = list(field = "os", type = "nominal",scale=list(scheme="set1")),
                    shape=list(field='major', type='nominal'),
                    opacity = list(condition = list(selection="opsys",value = 1),value = 0.1),
                    tooltip=list(list(field = "date",type="ordinal"),
                                 list(field=if('nightly' %in% f$channel) 'cv2' else 'cv', type='ordinal',title='Version'),
                                 list(field='cv', type='ordinal',title='Version'),
                                 list(field = "Adoption",type="ordinal"),
                                 list(field = xtip,type="ordinal")
                                 )
                )),
            list(
                mark = list(type="rule","strokeDash"=list(4, 2)),
                encoding = list(
                    size = list(value=1),
                    x = list(field="cv", type='ordinal',sort=list(field="ordering",op='count')),
                    y = list(field="lo90",type="quantitative",  grid=FALSE),
                    y2 = list(field="hi90",type="quantitative",  grid=FALSE),
                    opacity = list(condition = list(selection="opsys",value = 0.4),value = 0.1),
                    color = list(field = "os", type = "nominal",scale=list(scheme="grey")),
                    tooltip =  NULL
                ))
        )
    )
    u3
}

makePlot <- function(evo,typec,title,xtip,width=990,height=200){
    xx <- evo[os!='overall' & modelname == typec,]
    xx <-merge(xx, xx[, .SD[order(major,minor),][,list(date, major,minor, ordering = 1:.N)],by=os], by=c("os","date","major","minor"))
    xx[, xoff := runif(1),by=list(cv)]
    if(xtip=='Incidence') xx[,':='(c = c*100,lo90=lo90*100,hi90=hi90*100)]
    xy <- plotEvolution(xx, title=title, xtip=xtip,width=width,height=height)
    vegawidget(as_vegaspec(xy),embed=vega_embed(actions=TRUE))
}


```

##  {.tabset}



*Take results from products with less than 10% adoption with adequate  skepticism*


### Release 

`asOf` is the date till which the model uses data


```{r eval=TRUE, echo=FALSE}

datatable(release.info$version, caption = 'Comparing Current Version To ... ',
          colnames=c("Current Version","Days Present","Older Version","Days Present", "asOf"),
          options = list(
              searching = FALSE,columnDefs = list(list(className = 'dt-center',targets="_all")),
              pageLength = 1,lengthChange = FALSE,dom = 't'),rownames= FALSE
          )

datatable(release.info$usage[, DAU_on_Current := if(params$isPublic=='yes') NA else  DAU_on_Current],   caption = 'Usage on Current',
          colnames=c("OS","Adoption","Total Crashes","DAU On Current"),
          options = list(
              searching = FALSE,columnDefs = list(list(className = 'dt-center',targets="_all")),
              pageLength = nrow(release.info$usage),lengthChange = FALSE,dom = 't'),rownames= FALSE
          ) 



```



```{r echo=FALSE}
datatable(release.info$summary[type=='rate',list(os,Score,CM,CC)], caption = 'Crash Rate Summary',
          rownames=FALSE,colnames=c('OS','Score','Main Crash','Content Crash'),
          options = list(
              searching = FALSE,dom='t',lengthChange=FALSE,
              columnDefs = list(list(className = 'dt-center',targets="_all")),
              pageLength = nrow(release.info$usage)))

datatable(release.info$summary[type=='incidence',list(os,Score,CM,CC)], caption = 'Crash Incidence Summary',
          rownames=FALSE,colnames=c('OS','Score','Main Crash','Content Crash'),
          options = list(
              searching = FALSE,dom='t',lengthChange=FALSE,
              columnDefs = list(list(className = 'dt-center',targets="_all")),
              pageLength = nrow(release.info$usage)))

```




- Click on an OS in the legend to hide others and click on the chart to bring
them all back
- use scroll to zoom in/out figures


```{r echo=FALSE}
makePlot(release.info$evolution, 'cmr',"Main Crash Rate","Rate")
makePlot(release.info$evolution, 'ccr',"Content Crash Rate","Rate")
makePlot(release.info$evolution, 'cmi',"Main Crash Incidence(%)","Incidence")
makePlot(release.info$evolution, 'cci',"Content Crash Incidence(%)","Incidence")

```




### Beta



`asOf` is the date till which the model uses data



```{r}

datatable(beta.info$version, caption = 'Comparing Current Version To ... ',
          colnames=c("Current Version","Days Present","Older Version","Days Present", "asOf"),
          options = list(
              searching = FALSE,columnDefs = list(list(className = 'dt-center',targets="_all")),
              pageLength = nrow(beta.info$version),lengthChange = FALSE,dom = 't'),rownames= FALSE
          )

datatable(beta.info$usage[, DAU_on_Current := if(params$isPublic=='yes') NA else  DAU_on_Current],  caption = 'Usage on Current',
          colnames=c("OS","Adoption","Total Crashes","DAU On Current"),
          options = list(
              searching = FALSE,columnDefs = list(list(className = 'dt-center',targets="_all")),
              pageLength = nrow(beta.info$usage),lengthChange = FALSE,dom = 't'),rownames= FALSE
          ) 



```




```{r}
datatable(beta.info$summary[type=='rate',list(os,Score,CM,CC)], caption = 'Crash Rate Summary',
          rownames=FALSE,colnames=c('OS','Score','Main Crash','Content Crash'),
          options = list(
              searching = FALSE,dom='t',lengthChange=FALSE,
              columnDefs = list(list(className = 'dt-center',targets="_all")),
              pageLength = nrow(beta.info$usage)))

datatable(beta.info$summary[type=='incidence',list(os,Score,CM,CC)], caption = 'Crash Incidence Summary',
          rownames=FALSE,colnames=c('OS','Score','Main Crash','Content Crash'),
          options = list(
              searching = FALSE,dom='t',lengthChange=FALSE,
              columnDefs = list(list(className = 'dt-center',targets="_all")),
              pageLength = nrow(beta.info$usage)))

```



- Click on an OS in the legend to hide others and click on the chart to bring
them all back
- use scroll to zoom in/out figures





```{r}
makePlot(beta.info$evolution, 'cmr',"Main Crash Rate","Rate")
makePlot(beta.info$evolution, 'ccr',"Content Crash Rate","Rate")
makePlot(beta.info$evolution, 'cmi',"Main Crash Incidence(%)","Incidence")
makePlot(beta.info$evolution, 'cci',"Content Crash Incidence(%)","Incidence")

```









### Nightly

`asOf` is the date till which the model uses data

```{r}

datatable(nightly.info$version, caption = 'Comparing Current Version To ... ',
          colnames=c("Current Version","Days Present","Older Version","Days Present", "asOf"),
          options = list(
              searching = FALSE,columnDefs = list(list(className = 'dt-center',targets="_all")),
              pageLength = nrow(nightly.info$version),lengthChange = FALSE,dom = 't'),rownames= FALSE
          )

datatable(nightly.info$usage[, DAU_on_Current := if(params$isPublic=='yes') NA else  DAU_on_Current],  caption = 'Usage on Current',
          colnames=c("OS","Adoption","Total Crashes","DAU On Current"),
          options = list(
              searching = FALSE,columnDefs = list(list(className = 'dt-center',targets="_all")),
              pageLength = nrow(nightly.info$usage),lengthChange = FALSE,dom = 't'),rownames= FALSE
          ) 



```


```{r}
datatable(nightly.info$summary[type=='rate',list(os,Score,CM,CC)], caption = 'Crash Rate Summary',
          rownames=FALSE,colnames=c('OS','Score','Main Crash','Content Crash'),
          options = list(
              searching = FALSE,dom='t',lengthChange=FALSE,
              columnDefs = list(list(className = 'dt-center',targets="_all")),
              pageLength = nrow(nightly.info$usage)))

datatable(nightly.info$summary[type=='incidence',list(os,Score,CM,CC)], caption = 'Crash Incidence Summary',
          rownames=FALSE,colnames=c('OS','Score','Main Crash','Content Crash'),
          options = list(
              searching = FALSE,dom='t',lengthChange=FALSE,
              columnDefs = list(list(className = 'dt-center',targets="_all")),
              pageLength = nrow(nightly.info$usage)))

```


- Click on an OS in the legend to hide others and click on the chart to bring
them all back
- use scroll to zoom in/out figures





```{r}
makePlot(nightly.info$evolution, 'cmr',"Main Crash Rate","Rate")
makePlot(nightly.info$evolution, 'ccr',"Content Crash Rate","Rate")
makePlot(nightly.info$evolution, 'cmi',"Main Crash Incidence(%)","Incidence")
makePlot(nightly.info$evolution, 'cci',"Content Crash Incidence(%)","Incidence")

```


### Download CSV of Crash Metrics

You can download a CSV of crash rates/incidences for different operating systems
(and overall) ,different channels  and different versions (from last 6 months)  [here](./mc2_rate_incidence_evolution.csv)


### Definitions

- **Crash Incidence** is the proportion of DAU experiencing a crash (content or
  main as the case may be)
- **Crash Rate** is the crashes/active hour for the profiles experiencing  a crash  
- **os** is the operating system(Windows,Darwin,Linux and *overall* which is the average of the first three)
- **date** is the date on which this estimate was computed
- **cv** the version
- **major** and **minor** the major and minor components
- **adoption** what percent of DAU was from this version on the given `date`
- **modelname** we have four (+2) different metrics
  - **cmi** is *Main Crash Incidence*, the proportion of DAU on that version that experience a main crash
  - **cmr** is *Main Crash Rate*, the number of crashes per active hour for the people experiencing crash
  - **cci** and **ccr** are similar to the above but for *Content* crashes
  - **cm** and **cc** are the *sum* of **(cmi,ccr)** and **(cmicci)** respectively
- **c** is the actual rate/incidence (incidence is a proportion)
- **orig** the original value (won't exist for `score`,`cc` and `cm`)
- **lo90** and **hi90** are upper and lower bounds

All estimates are comparable in that they estimated at comparable adoptions and
other parameters


In the 'Summary Tables' , the format `X (Y%)` is the actual rate followed by the percent relative change wrt to the `Older_Version`. Based on the following rules

- if we are more than 75% confident of 20%+ regression you will see a ▲ 
- if we are between 60-75% confident of a 20%+ regression you will see △
- if we are more than 75% confident of a 20%+ improvement you will see a ▼ arrow
- otherwise nothing


#### Appendix : Models

```{r echo=FALSE}
y <- model.summary(g)
cat(y$allmods)
```
